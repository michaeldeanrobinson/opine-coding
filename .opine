# Repository Opinions

## Architecture
- Vertical Slice Architecture (VSA); features are the unit of organisation, not layers.
- One namespace per file.
- All code projects reside under `src/`.
- Use `.slnx` solution format — not `.sln`.
- Target framework: `net10.0`; `<LangVersion>latest</LangVersion>`; `<Nullable>enable</Nullable>` — set globally in `src/Directory.Build.props`, never per `.csproj`.
- Centralize all package versions in `src/Directory.Packages.props` (`<ManagePackageVersionsCentrally>true</ManagePackageVersionsCentrally>`); no version attributes in individual `.csproj` files.
- `src/` is the exclusive project boundary — no projects, `Directory.Build.props`, or `Directory.Packages.props` exist outside it.
- The `tools/` directory at the repo root is permitted for non-.NET tooling scripts (e.g. Node.js asset generation); it contains no C# code and is not subject to `src/` conventions.
- On solution creation, generate a `.editorconfig` that encodes all active rules from `.opine`. No `.ruleset` files; no `stylecop.json` — `.editorconfig` is the single source of analyzer configuration.

## Vertical Slices
- Organise by feature, not layer. Every feature lives under `Features/{FeatureName}/`.
- A slice is self-contained: endpoint, request record, response record, and handler all reside in the same folder.
- Slice folder template:
  ```
  Features/
    {FeatureName}/
      {FeatureName}Endpoint.cs   ← implements IEndpoint
      {FeatureName}Request.cs    ← record
      {FeatureName}Response.cs   ← record
      {FeatureName}Handler.cs    ← business logic, internal to the slice
  ```
- Namespace mirrors folder path: `{Project}.Features.{FeatureName}`.
- Endpoints self-register via `IEndpoint` (`void MapEndpoint(IEndpointRouteBuilder app)`) defined in `Common/IEndpoint.cs` under namespace `{Project}.Common`; `WebApplicationExtensions` scans using `typeof(IEndpoint).Assembly.GetTypes()` — not `Assembly.GetExecutingAssembly()` — and calls each implementation at startup.
- `IEndpoint` implementations must have a public parameterless constructor — `Activator.CreateInstance` is used for registration; inject dependencies via Minimal API parameter binding inside `MapEndpoint`, not via the constructor.
- `IEndpoint` implementations are `internal sealed`. Request and response records are `public sealed record`. Handler classes are `internal static class` — handler logic stays private to the slice.
- Shared contracts (e.g. pagination, error envelopes) live in `Common/`. Shared infrastructure (DbContext, HTTP clients, external service wrappers) lives in `Infrastructure/`. ASP.NET Core pipeline concerns (exception handlers, request logging) live in `Middleware/`. Nothing else is shared.
- A slice may not reference another slice. If two slices need the same type, move it to `Common/` or duplicate it — coupling is worse than duplication here.

## C# Patterns
- Use Primary Constructors.
- Favor `sealed records` for DTOs — always `public sealed record Foo(...)`.
- Use language keywords for declarations: `string x`, `int y`. Use BCL type names for static member access: `String.IsNullOrEmpty`, `Int32.Parse`.
- Use `""` not `string.Empty`.
- Use `int?` not `Nullable<int>`.
- `readonly` on all eligible fields.
- Expression-bodied: ✅ accessors/properties — ❌ constructors/methods.
- Use collection expressions (`[]`) for all empty and initialized collections — supersedes `Array.Empty<T>()` and `new T[] { }` / `new List<T> { }` syntax.
- Prefer object initializers, null propagation (`?.`), null coalescing (`??`), throw expressions, index (`^`) and range (`..`) operators.

## Naming
- Private instance fields: `_camelCase`. No `m_` prefix.
- Types, methods, properties: `PascalCase`.
- Interfaces: prefix `I`.
- Type parameters: prefix `T`.
- Variables and parameters: `camelCase`.
- Tuple element names: explicit (not inferred), `PascalCase`.
- No type names used as parameter or variable identifiers.
- No `this.` prefix on local calls.

## Formatting
- 4-space indent for `.cs`; 2-space for `.csproj`. Spaces, not tabs.
- CRLF line endings; UTF-8; always insert final newline.
- Open brace on new line for all blocks.
- Always use braces — no braceless control flow.
- Long parameter/argument lists: one parameter per line.
- Never use `var` — always explicit types.

## Usings
- `<ImplicitUsings>enable</ImplicitUsings>` is set in `src/Directory.Build.props` — common `System.*` namespaces are auto-included; do not re-declare them.
- `System` directives first for any explicit usings.
- Usings outside namespace.
- No unnecessary usings.

## Async
- `ValueTask.FromResult` for synchronous interface implementations; `Task.FromResult` only when the caller requires `Task<T>`.
- Forward `CancellationToken` where applicable.
- `ConfigureAwait(false)` not required (ASP.NET Core context).

## Security
- No hardcoded credentials.
- No SQL string concatenation or format string injection — use parameterized queries.
- Always specify `StringComparison` in string comparisons.

## API Defaults
- Use Minimal API structure — no MVC controllers.
- Startup wiring lives in `Extensions/WebApplicationExtensions.cs` as `internal static` extension methods on `WebApplication`; all such methods return `WebApplication` to support fluent chaining.
- Always register health checks; map `/health` (full) and `/alive` (liveness — `Predicate = _ => false` to exclude all checks) by default.
- The `"/"` root endpoint and all static asset endpoints must chain `.AllowAnonymous().ExcludeFromDescription()`.
- Do not register `UseStaticFiles()` middleware in API projects — it enables indiscriminate static file serving.
- Serve static assets (e.g. `favicon.ico`) via dedicated `MapGet` endpoints: resolve the path via `IWebHostEnvironment.WebRootPath`; guard with `String.IsNullOrEmpty(env.WebRootPath)` before calling `Path.Combine`; return `Results.NoContent()` if the path is empty or the file does not exist, otherwise `Results.File` with an explicit MIME type (`image/x-icon` for `.ico`); chain `.AllowAnonymous().ExcludeFromDescription().CacheOutput(policy => policy.Expire(TimeSpan.FromDays(7)))`.
- Static assets (favicon, social preview, etc.) are placed in `wwwroot/` under the API project; served only via explicit `MapGet` endpoints, never via `UseStaticFiles()`.
- Register middleware in this order before `app.Run()`: `UseExceptionHandler()` first, then `MapDefaultHealthChecks()`, then `MapDefaultEndpoints()`.
- Feature endpoints must chain `.WithName("{FeatureName}").Produces<{FeatureName}Response>()` for OpenAPI discoverability.

## Logging
- Use Serilog as the logging provider (`Serilog.AspNetCore`).
- In `Program.cs`, create a bootstrap logger (`WriteTo.Console().CreateBootstrapLogger()`) before the try block so startup failures are captured.
- Replace the bootstrap logger with the full pipeline logger via `builder.Host.UseSerilog(...)` using `ReadFrom.Configuration` and `ReadFrom.Services`.
- Default sink: Console. OpenTelemetry will be added as an additional sink later.

## Documentation
- XML doc comments not required.

## No-Go Zone
- No `try-catch` in application or request-handling code — handle exceptions via `IExceptionHandler` registered with `builder.Services.AddExceptionHandler<T>()` and activated with `app.UseExceptionHandler()`.
- Exception: the Serilog startup bootstrap `try/catch/finally` in `Program.cs` is required to capture startup failures and flush the logger.
- No `#region` directives.
- No `var`.
- No `this.` prefix.
- No hardcoded credentials or SQL string building.
- No `UseStaticFiles()` in API projects — serve static assets via dedicated endpoints.
- No cross-slice references — a feature slice must not import types from another feature slice.
- No central routing file — each slice registers its own endpoint via `IEndpoint`.
